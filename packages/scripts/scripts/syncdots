#!/bin/sh 
 
set -e 

GIT_CLONE_PATH=~/projects/github.com/JunichiSugiura
STOW_PACKAGES_PATH="$GIT_CLONE_PATH"/dotfiles/packages

ensure_dir() {
    path=$1
    if [ ! -d "$path" ]; then
        mkdir -p "$path"
    fi
}

ensure_asdf_plugin() {
    plugin=$1
    git_repo=$2
    if [ ! -d ~/.asdf/plugins/"$plugin" ]; then
        asdf plugin-add "$plugin" "$git_repo"
    fi

    version=$(grep -n nodejs "$STOW_PACKAGES_PATH"/asdf/.tool-versions | cut -d ' ' -f 2)
    if [ ! -d ~/.asdf/installs/"$plugin"/"$version" ]; then
        if [ "$plugin" = nodejs ]; then
            bash -c '${ASDF_DATA_DIR:=$HOME/.asdf}/plugins/nodejs/bin/import-release-team-keyring'
        fi
        asdf install "$plugin"
    fi
}
 
echo 'Change default shell to zsh'
if [ "$(dscl . -read ~/ UserShell)" = "UserShell: /bin/bash" ]; then 
    chsh -s /bin/zsh
    chmod -R 755 /usr/local/share/zsh
    chown -R root:staff zsh
fi 

echo 'Setup Homebrew'
if [ ! -f /usr/local/bin/brew ]; then
    /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install.sh)"
fi

echo 'Setup NodeJS'
ensure_asdf_plugin nodejs https://github.com/asdf-vm/asdf-nodejs.git 

echo 'Clone dotfiles'
ensure_dir "$GIT_CLONE_PATH"

if [ ! -d "$GIT_CLONE_PATH"/dotfiles ]; then
    cd "$GIT_CLONE_PATH"
    git clone git@github.com:JunichiSugiura/dotfiles.git
fi

echo 'Install Apps and CLIs'
brew bundle --file "$GIT_CLONE_PATH"/dotfiles/Brewfile

echo 'Link dotfiles'
ensure_dir ~/.config/alacritty
ensure_dir ~/.config/starship
ensure_dir ~/.config/yarn/global

# shellcheck disable=SC2046
stow -d "$STOW_PACKAGES_PATH" -t ~ $(ls packages)

# enable key-repeating with vim bindings
defaults write com.microsoft.VSCodeInsiders ApplePressAndHoldEnabled -bool false

echo 'Setup gpg signing with git'
if [ ! -d ~/.gnupg ] || [ -z "$(gpg --list-secret-keys --keyid-format LONG)" ]; then
    gpg --default-new-key-algo rsa4096 --gen-key
    key_id=$(gpg --list-secret-keys --keyid-format LONG | ggrep -oP "rsa4096\/[0-9a-fA-F]{16}" | cut -d"/"  -f2)
    echo 'Copy and pates the GPG key below to GitHub'
    gpg --armor --export "$key_id"
    git config --global user.signingkey "$key_id"
fi

if [ ! -f ~/.ssh/id_rsa.pub ]; then
    ssh-keygen -t rsa -b 4096 -C "jun.sugiura.jp@gmail.com"
    echo 'Copy and pates the SSH key below to GitHub'
    cat ~/.ssh/id_rsa.pub
fi

echo 'Setup Ruby'
ensure_asdf_plugin ruby https://github.com/asdf-vm/asdf-ruby.git

echo 'Setup Rust'
ensure_asdf_plugin rust https://github.com/code-lever/asdf-rust.git

echo 'Setup Golang'
ensure_asdf_plugin golang https://github.com/kennyp/asdf-golang.git

echo 'Setup Deno'
ensure_asdf_plugin deno https://github.com/asdf-community/asdf-deno.git

echo 'Setup Yarn global'
if [ ! -d ~/.config/yarn/global/node_modules ]; then
    yarn global add
fi

echo 'Setup yabai'
if [ ! -d /Library/ScriptingAdditions/yabai.osax ]; then
    sudo yabai --install-sa
fi
