#!/bin/sh

for i in "$@"; do
    case "$i" in
        -r=*|--reverse=*)
            reverse="${i#*=}"
            shift ;;
        *) ;;
    esac
done

current_display_id=$(yabai -m query --displays --display | jq '.id')
target_display_index=$(yabai -m query --displays \
    | jq \
        --arg id "$current_display_id" \
        --arg reverse "$reverse" '
            {
                index: map(select(.id | tostring == $id))[0].index,
                length: . | length
            }
            | if $reverse == "1" then
                if .index == 1 then
                    .length
                else
                    .index - 1
                end
            else
                if .index == .length then
                    1
                else
                    .index + 1
                end
            end
        ')

current_app=$(yabai -m query --windows --window | jq ".app")
target_window_ids=$(yabai -m query --windows \
    | jq --arg app "$current_app" '
        map(select(.app == ($app | fromjson)))
        | reverse
        | .[].id
    ')

echo "$target_window_ids" | tr ' ' '\n' | while read id; do
    yabai -m window "$id" --display "$target_display_index"
    yabai -m window "$id" --grid 1:1:0:0:1:1
    yabai -m window --focus "$id"
done
